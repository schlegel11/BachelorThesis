{"generator":"Code Snippets v2.13.3","date_created":"2019-06-05 02:23","snippets":[{"name":"MobileCoach Deepstream send message prototype","scope":"front-end","code":"add_shortcode('shortcode_mobilecoach_send_message_prototype', function () {\n\t\/\/ Added deepstream library to lib folder.\t\n\trequire_once(ABSPATH . 'lib\/deepstream.io-client-php-1.0.1\/src\/DeepstreamClient.php');\n\tglobal $wpdb;\n\n\tfunction send_external_message($participants = [], $variables)\n\t{\n\t\t$client = new \\Deepstreamhub\\DeepstreamClient(\"https:\/\/ba.eatnbyte.com\/ds-http\/\", array('token' => '1;external-system;jwdki890-mgj92yeay9c;PLEASE_REPASTE_COMPLETE_TOKEN_FROM_MOBILE_COACH'));\n\t\t$result = $client->makeRpc('external-message', array('systemId' => 'jwdki890-mgj92yeay9c', 'participants' => $participants, 'variables' => $variables));\n\n\t\treturn $result;\n\t}\n\t?>\n\n\t<meta charset=\"utf-8\">\n\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1, shrink-to-fit=no\">\n\t<meta http-equiv=\"x-ua-compatible\" content=\"ie=edge\">\n\t<!-- Font Awesome -->\n\t<link rel=\"stylesheet\" href=\"https:\/\/cdnjs.cloudflare.com\/ajax\/libs\/font-awesome\/5.8.1\/css\/all.css\">\n\t<!-- Bootstrap core CSS -->\n\t<link href=\"https:\/\/cdnjs.cloudflare.com\/ajax\/libs\/twitter-bootstrap\/4.3.1\/css\/bootstrap.min.css\" rel=\"stylesheet\">\n\t<!-- Material Design Bootstrap -->\n\t<link href=\"https:\/\/cdnjs.cloudflare.com\/ajax\/libs\/mdbootstrap\/4.8.0\/css\/mdb.min.css\" rel=\"stylesheet\">\n\t<!-- SCRIPTS -->\n\t<!-- JQuery -->\n\t<script type=\"text\/javascript\" src=\"https:\/\/cdnjs.cloudflare.com\/ajax\/libs\/jquery\/3.4.1\/jquery.min.js\"><\/script>\n\t<!-- Bootstrap tooltips -->\n\t<script type=\"text\/javascript\" src=\"https:\/\/cdnjs.cloudflare.com\/ajax\/libs\/popper.js\/1.15.0\/popper.min.js\"><\/script>\n\t<!-- Bootstrap core JavaScript -->\n\t<script type=\"text\/javascript\" src=\"https:\/\/cdnjs.cloudflare.com\/ajax\/libs\/twitter-bootstrap\/4.3.1\/js\/bootstrap.min.js\"><\/script>\n\t<!-- MDB core JavaScript -->\n\t<script type=\"text\/javascript\" src=\"https:\/\/cdnjs.cloudflare.com\/ajax\/libs\/mdbootstrap\/4.8.0\/js\/mdb.min.js\"><\/script>\n\n\t<style>\n\t\t.invalid-feedback {\n\t\t\tdisplay: none;\n\t\t\twidth: 100%;\n\t\t\tmargin-top: 0.25rem;\n\t\t\tfont-size: 110%;\n\t\t\tcolor: #dc3545;\n\t\t}\n\n\t\t.vertical-center {\n\t\t\tmin-height: 100%;\n\t\t\tmin-height: 100vh;\n\t\t\tdisplay: flex;\n\t\t\talign-items: center;\n\t\t}\n\t<\/style>\n\n\t<!-- HTML form. -->\n\t<div class=\"container-fluid vertical-center\" bgcolor=\"#E6E6FA\">\n\t\t<div class=\"col\">\n\t\t\t<div class=\"row justify-content-center align-items-center\">\n\t\t\t\t<div class=\"col\">\n\t\t\t\t\t<div class=\"card\">\n\t\t\t\t\t\t<div class=\"card-body\">\n\t\t\t\t\t\t\t<form action=\"\" autocomplete=\"off\" method=\"post\">\n\t\t\t\t\t\t\t\t<h2>Verbundene MobileCoach-Nutzer<\/h2>\n\t\t\t\t\t\t\t\t<table class=\"table table-hover\">\n\t\t\t\t\t\t\t\t\t<thead>\n\t\t\t\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t\t\t\t<th>Auswahl<\/th>\n\t\t\t\t\t\t\t\t\t\t\t<th>Nutzername<\/th>\n\t\t\t\t\t\t\t\t\t\t\t<th>E-Mail-Adresse<\/th>\n\t\t\t\t\t\t\t\t\t\t\t<th>MobileCoach-TeilnehmerID<\/th>\n\t\t\t\t\t\t\t\t\t\t<\/tr>\n\t\t\t\t\t\t\t\t\t<\/thead>\n\t\t\t\t\t\t\t\t\t<tbody>\n\t\t\t\t\t\t\t\t\t\t<?php\n\n\t\t\t\t\t\t\t\t\t\t$result = $wpdb->get_results('SELECT * FROM ' . $wpdb->prefix . 'mc_participants AS wpmcp INNER JOIN ' . $wpdb->users . ' AS wpu ON wpmcp.wp_users_id=wpu.id');\n\t\t\t\t\t\t\t\t\t\tforeach ($result as $row) {\n\n\t\t\t\t\t\t\t\t\t\t\techo '<tr>';\n\t\t\t\t\t\t\t\t\t\t\techo '<td><input type=\"checkbox\" class=\"form-check-input\" name=\"participants[]\" value=\"' . $row->participant_id . '\"><\/td>';\n\t\t\t\t\t\t\t\t\t\t\techo '<td><input type=\"hidden\" name=\"display_name\" value=\"' . $row->display_name . '\">' . $row->display_name . '<\/td>';\n\t\t\t\t\t\t\t\t\t\t\techo '<td><input type=\"hidden\" name=\"mail\" value=\"' . $row->user_email . '\">' . $row->user_email . '<\/td>';\n\t\t\t\t\t\t\t\t\t\t\techo \"<td>$row->participant_id<\/td>\";\n\t\t\t\t\t\t\t\t\t\t\techo '<\/tr>';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t?>\n\t\t\t\t\t\t\t\t\t<\/tbody>\n\t\t\t\t\t\t\t\t<\/table>\t\n\t\t\t\t\t\t\t\t<div class=\"row\" >\n\t\t\t\t\t\t\t\t<button type=\"submit\" name=\"sendMessage\" class=\"btn btn-lg btn-geton\">Test Nachricht senden<\/button>\n\t\t\t\t\t\t\t\t<button type=\"submit\" name=\"sendDialogA\" class=\"btn btn-lg btn-geton\">Dialog A starten<\/button>\n\t\t\t\t\t\t\t\t<button type=\"submit\" name=\"sendDialogEnd\" class=\"btn btn-lg btn-geton\">Dialog beenden<\/button>\n\t\t\t\t\t\t\t\t<button type=\"submit\" name=\"removeParticipant\" class=\"btn btn-lg btn-geton\">L\u00f6sche Alle MobileCoach Verbindungen<\/button>\n\t\t\t\t\t\t\t\t<button class=\"btn btn-lg btn-geton\" onClick=\"window.location.href=window.location.href\">Aktualisieren<\/button>\n\t\t\t\t\t\t\t\t<div class=\"w-100\"><\/div>\n\t\t\t\t\t\t\t\t<label>\t\t\t\n\t\t\t\t\t\t\t\tAnzahl ausgehender Test Nachrichten:\n\t\t\t\t\t\t\t\t<input type=\"number\" min=\"1\" max=\"25\" step=\"1\" value=\"1\" size=\"2\" name=\"messageCount\">\n\t\t\t\t\t\t\t\t<\/label>\n\t\t\t\t\t\t\t\t<\/div>\t\t\t\n\t\t\t\t\t\t\t<\/form>\n\t\t\t\t\t\t<\/div>\n\t\t\t\t\t<\/div>\n\t\t\t\t<\/div>\n\t\t\t<\/div>\n\t\t\t<div class=\"row mt-3 justify-content-left align-items-left\">\n\t\t\t\t<div class=\"col\">\n\t\t\t\t\t<p class=\"text-left\" style=\"font-size: 180%; color: #dc3545;\">\n\t\t\t\t\t\t<?php\n\t\t\t\t\t\tif ($_SERVER['REQUEST_METHOD'] === 'POST'){\n\n\t\t\t\t\t\t\t$participantss = array();\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$result = $wpdb->get_results('SELECT a.participant_id, b.login_date\nFROM '. $wpdb->prefix .'mc_participants a\n       INNER JOIN (SELECT user_id,\n                          user_login,\n                          login_date\n                   FROM '. $wpdb->prefix .'aiowps_login_activity\n                   WHERE  ( user_id, user_login, login_date ) IN (SELECT\n                          user_id,\n                          user_login,\n                          Max(login_date)\n                                                                  FROM\n                          '. $wpdb->prefix .'aiowps_login_activity\n                          GROUP  BY user_id)\n                          AND Datediff(Now(), login_date) > -7) b\n               ON a.wp_users_id = b.user_id');\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\tforeach ($result as $row) {\n\t\t\t\t\t\t\t\t\t\t\techo $row->participant_id;\n\t\t\t\t\t\t\t\t\t\t\techo is_string($row->login_date) ? 'a' : 'b';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\tif ($_SERVER['REQUEST_METHOD'] === 'POST' && !empty($_POST['participants'])) {\n\t\t\t\t\t\t\t$participants = $_POST['participants'];\n\t\t\t\t\t\t\t$display_name = $_POST['display_name'];\n\t\t\t\t\t\t\t$mail = $_POST['mail'];\n\t\t\t\t\t\t\t$sendMessageCount = $_POST['messageCount'];\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tif (isset($_POST['sendMessage'])) {\n\t\t\t\t\t\t\t\tfor ($i = 0; $i < $sendMessageCount; $i++) {\n\t\t\t\t\t\t\t\t$result = send_external_message($participants, array('messageType' => 'Test', 'testFeldA' => \"GET.ON Nutzer: $display_name\", 'testFeldB' => \"GET.ON Mail: $mail\"));\n\t\t\t\t\t\t\t\techo $result ? \"Nachricht wurde versendet\" : \"Es ist ein Fehler aufgetreten. Nachricht konnte nicht verarbeitet werden. Siehe MobileCoach-Server Logs.\";\n\t\t\t\t\t\t\t\t}\t\n\t\t\t\t\t\t\t} else if (isset($_POST['sendDialogA'])) {\n\t\t\t\t\t\t\t\t$result = send_external_message($participants, array('messageType' => 'DialogA', 'nutzername' => \"$display_name\", 'kraftquelle' => \"Am Ende wird alles gut. Wenn es nicht gut wird, ist es noch nicht das Ende.\"));\n\t\t\t\t\t\t\t\techo $result ? \"Nachricht wurde versendet\" : \"Es ist ein Fehler aufgetreten. Nachricht konnte nicht verarbeitet werden. Siehe MobileCoach-Server Logs.\";\n\t\t\t\t\t\t\t} else if (isset($_POST['sendDialogEnd'])) {\n\t\t\t\t\t\t\t\t$result = send_external_message($participants, array('messageType' => 'DialogEnd', 'nutzername' => \"$display_name\"));\n\t\t\t\t\t\t\t\techo $result ? \"Nachricht wurde versendet\" : \"Es ist ein Fehler aufgetreten. Nachricht konnte nicht verarbeitet werden. Siehe MobileCoach-Server Logs.\";\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['removeParticipant'])) {\n\t\t\t\t\t\t\t$wpdb->query(\"DELETE FROM \" . $wpdb->prefix . \"mc_participants\");\n\t\t\t\t\t\t}\n\t\t\t\t\t\t?>\n\t\t\t\t\t<\/p>\n\t\t\t\t<\/div>\n\t\t\t<\/div>\n\t\t<\/div>\n\t<\/div>\n<?php\n});\n","priority":"10"}]}
